import winreg
from classes.RegistryTree import RegistryTree

class WindowsDefenderAnalyzer:
    def __init__(self):

        self.defenderRegistry = [
            "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender",
            "HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender",
            "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy"
        ]


    def makeSnapshot(self):

        snapShots = []

        for path in self.defenderRegistry:
            registryTree = self.makeTree(path)
            snapShots.append(registryTree)

        return snapShots

    def makeTree(self, fullPath):
        hkey, path = self.prepareRegistryPath(fullPath)
        soft = winreg.OpenKey(hkey, path)

        Rt = RegistryTree()
        Rt.currentKey = fullPath

        i = 0

        while True:
            try:
                name, valueData, identifier = winreg.EnumValue(soft, i)

                Rt.values[name] = valueData

                i += 1
            except OSError:
                break

        j = 0
        while True:
            try:
                key = winreg.EnumKey(soft, j)

                childKey = fullPath + f"\\{key}"
                childTree = self.makeTree(childKey)

                Rt.childKeys.append(childTree)

                j += 1
            except OSError:
                break

        return Rt

    def prepareRegistryPath(self, path):
        HKeyString, restOfPath = path.split("\\", 1)

        match HKeyString:
            case "HKEY_LOCAL_MACHINE":
                return winreg.HKEY_LOCAL_MACHINE, restOfPath
            case "HKEY_CURRENT_USER":
                return winreg.HKEY_CURRENT_USER, restOfPath