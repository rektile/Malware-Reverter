from classes.RegistryAnalyzer import RegistryAnalyzer
from classes.FolderAnalyzer import FolderAnalyzer
from classes.WindowsSchedulerAnalyzer import WindowsSchedulerAnalyzer

class MalwareAnalyzer:
    def __init__(self):

        self.registryAnalyzer = RegistryAnalyzer()
        self.folderAnalyzer = FolderAnalyzer()
        self.windowsSchedulerAnalyzer = WindowsSchedulerAnalyzer()

        self.firstScan = None
        self.secondScan = None

    def compareSnapshots(self, snap1, snap2):
        differenceSet = set(snap2.keys()) - set(snap1.keys())
        difference = {key: snap2[key] for key in differenceSet}

        return difference

    def mergeDifferences(self, *args):

        mergedDifference = {}
        for dic in args:
            for key, value in dic.items():
                key = key.lower()
                if key in mergedDifference:

                    mergedDifference[key].merge(value)
                else:
                    mergedDifference[key] = value

        return mergedDifference

    def showChanges(self, differences):

        registryChanges = set()
        fileChanges = set()
        schedulerChanges = set()

        print()

        for key, program in differences.items():
            registryChanges.update(program.registryPaths)
            fileChanges.update(program.filePaths)
            schedulerChanges.update(program.taskSchedule)

        print("[!] These changes have been made in the registry: ")
        for path in registryChanges:
            print(path)

        print()

        print("[!] These files might be dangerous: ")
        for path in fileChanges:
            print(path)

        print()


        print("[!] These schedules have been made: ")
        for schedule in schedulerChanges:
            print(schedule)

        print()

    def run(self):
        print(f"[*] Making first snapshot...")

        registrySnap1 = self.registryAnalyzer.makeSnapshot()
        folderSnap1 = self.folderAnalyzer.makeSnapshot()
        schedulerSnap1 = self.windowsSchedulerAnalyzer.makeSnapshot()

        print(f"[*] Completed snapshot 1")

        input("[-] Press enter when you have fully executed the program. ")

        print(f"[*] Making second snapshot...")

        registrySnap2 = self.registryAnalyzer.makeSnapshot()
        folderSnap2 = self.folderAnalyzer.makeSnapshot()
        schedulerSnap2 = self.windowsSchedulerAnalyzer.makeSnapshot()

        print("[*] Comparing snapshots.")

        registryDifference = self.compareSnapshots(registrySnap1, registrySnap2)
        folderDifference = self.compareSnapshots(folderSnap1, folderSnap2)
        schedulerDifference = self.compareSnapshots(schedulerSnap1, schedulerSnap2)

        mergedDifference = self.mergeDifferences(registryDifference, folderDifference, schedulerDifference)

        self.showChanges(mergedDifference)